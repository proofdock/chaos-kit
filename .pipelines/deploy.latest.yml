trigger:
  - master

pr:
  - master


stages:
  - stage: verify
    jobs:
      - template: templates/verify.yml  # Verify Python 3.5
        parameters:
          version: 3.5
          display_version: 3_5
      - template: templates/verify.yml  # Verify Python 3.6
        parameters:
          version: 3.6
          display_version: 3_6
      - template: templates/verify.yml  # Verify Python 3.7
        parameters:
          version: 3.7
          display_version: 3_7
      - template: templates/verify.yml  # Verify Python 3.8
        parameters:
          version: 3.8
          display_version: 3_8
  - stage: deploy
    displayName: deploy:latest
    dependsOn: verify
    jobs:
      - deployment: latest
        condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/heads/master'))
        pool:
          vmImage: "ubuntu-latest"
        environment: latest
        variables:
          - group: shared
        strategy:
          runOnce:
            deploy:
              steps:
                - download: none
                - template: templates/deploy.prepare.yml
                - script: bump2version build
                  displayName: 'bump build version'
                - script: python setup.py sdist bdist_wheel
                  displayName: 'Generate package'
                - task: TwineAuthenticate@1
                  inputs:
                    artifactFeed: 'proofdockio'
                - script: python -m twine upload --repository proofdockio --config-file $(PYPIRC_PATH) dist/*
                  displayName: 'Upload package to test PyPI'
                - template: templates/deploy.commit.yml